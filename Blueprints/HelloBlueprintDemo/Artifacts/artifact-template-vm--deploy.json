{
    "kind": "template",
    "name": "VirtualMachine",
    "properties": {
        "displayName": "Virtual Machines",
        "description": "Virtual Machines that will host our DevOps agents.",
        "dependsOn": [
            "artifact-template-keyvault--deploy",
            "artifact-template-network-interface--deploy",
            "artifact-template-storage-account--deploy",
            "artifact-template-loganalytics--deploy"
        ],
        "template": {
            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
            "contentVersion": "1.0.0.0",
            "parameters": {
                "Prefix": {
                    "type": "string"
                },
                "Location": {
                    "type": "string"
                },
                "Cluster_Size": {
                    "type": "int"
                },
                "Operating_System": {
                    "type": "string",
                    "allowedValues": [
                        "Windows",
                        "Linux"
                    ]
                },
                "adminUserName": {
                    "type": "string",
                    "defaultValue": "ansible"
                },
                "KeyVault_Reference": {
                    "type": "string"
                },
                "KeyVault_AdminPassword": {
                    "type": "securestring"
                },
                "KeyVault_AdminSsh": {
                    "type": "securestring"
                },
                "StorageAccount_BlobUri": {
                    "type": "string"
                },
                "LogAnalytics_WorkspaceId": {
                    "type": "string"
                },
                "LogAnalytics_WorkspacePrimaryKey": {
                    "type": "securestring"
                },
                "StorageAccount_Name": {
                    "type": "string"
                },
                "StorageAccount_Id": {
                    "type": "string"
                },
                "sasRequestBody": {
                    "type": "object",
                    "defaultValue": {
                        "signedServices": "bt",
                        "signedResourceTypes": "cos",
                        "signedPermission": "racwdlup",
                        "signedProtocol": "https,http",
                        "signedExpiry": "2020-09-19T21:00:00Z",
                        "keyToSign": "key1"
                    },
                    "metadata": {
                        "displayName": "SAS Token Request Body",
                        "description": "Request Body necessary for SAS Token retrieval with the 'listAccountSas()' function."
                    }
                },
                "QualysAgent_LicenseCode": {
                    "type": "string"
                },
                "QualysAgentLinux_LicenseCode": {
                    "type": "string"
                }
            },
            "variables": {
                "vmName": "[concat(parameters('Prefix'), '-VM-')]",
                "vmImage": {
                    "Linux": {
                        "publisher": "Canonical",
                        "offer": "UbuntuServer",
                        "sku": "18.04-LTS",
                        "version": "latest"
                    },
                    "Windows": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    }
                },
                "wadlogs": "<WadCfg> <DiagnosticMonitorConfiguration overallQuotaInMB=\"4096\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"> <DiagnosticInfrastructureLogs scheduledTransferLogLevelFilter=\"Error\"/> <WindowsEventLog scheduledTransferPeriod=\"PT1M\" > <DataSource name=\"Application!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"Security!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"System!*[System[(Level = 1 or Level = 2)]]\" /></WindowsEventLog>",
                "wadperfcounters1": "<PerformanceCounters scheduledTransferPeriod=\"PT1M\"><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU utilization\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Privileged Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU privileged time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% User Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU user time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor Information(_Total)\\Processor Frequency\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"CPU frequency\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\System\\Processes\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Processes\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Thread Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Threads\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Handle Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Handles\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\% Committed Bytes In Use\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Memory usage\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Available Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory available\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory committed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Commit Limit\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory commit limit\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active time\" locale=\"en-us\"/></PerformanceCounterConfiguration>",
                "wadperfcounters2": "<PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Read Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active read time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Write Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active write time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Transfers/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Reads/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk read operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Writes/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk write operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Read Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk read speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Write Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk write speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\LogicalDisk(_Total)\\% Free Space\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk free space (percentage)\" locale=\"en-us\"/></PerformanceCounterConfiguration></PerformanceCounters>",
                "wadcfgxstart": "[concat(variables('wadlogs'), variables('wadperfcounters1'), variables('wadperfcounters2'), '<Metrics resourceId=\"')]",
                "wadmetricsresourceid": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups', parameters('Prefix'), '-Compute-RG/providers/Microsoft.Compute/virtualMachines/')]",
                "wadcfgxend": "\"><MetricAggregation scheduledTransferPeriod=\"PT1H\"/><MetricAggregation scheduledTransferPeriod=\"PT1M\"/></Metrics></DiagnosticMonitorConfiguration></WadCfg>"
            },
            "resources": [
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex())]",
                    "location": "[parameters('Location')]",
                    "copy": {
                        "name": "VM-Copy_Linux",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "hardwareProfile": {
                            "vmSize": "Standard_F2s_v2"
                        },
                        "storageProfile": {
                            "imageReference": {
                                "publisher": "[variables('vmImage')[parameters('Operating_System')].publisher]",
                                "offer": "[variables('vmImage')[parameters('Operating_System')].offer]",
                                "sku": "[variables('vmImage')[parameters('Operating_System')].sku]",
                                "version": "[variables('vmImage')[parameters('Operating_System')].version]"
                            },
                            "dataDisks": [],
                            "osDisk": {
                                "name": "[concat(variables('vmName'), 'OSDisk-', copyIndex())]",
                                "createOption": "FromImage",
                                "caching": "ReadWrite",
                                "diskSizeGB": 30
                            }
                        },
                        "osProfile": {
                            "computerName": "[concat('My', parameters('Operating_System'), 'Agent-', copyIndex())]",
                            "adminUserName": "[parameters('adminUserName')]",
                            "linuxConfiguration": {
                                "disablePasswordAuthentication": true,
                                "provisionVMAgent": true,
                                "ssh": {
                                    "publicKeys": [
                                        {
                                            "path": "[concat('/home/', parameters('adminUserName'), '/.ssh/authorized_keys')]",
                                            "keyData": "[parameters('KeyVault_AdminSsh')]"
                                        }
                                    ]
                                }
                            }
                        },
                        "networkProfile": {
                            "networkInterfaces": [
                                {
                                    "id": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups/', parameters('Prefix'), '-Network-RG/providers/Microsoft.Network/networkInterfaces/', parameters('Prefix'), '-NIC-', copyIndex())]",
                                    "properties": {
                                        "primary": true
                                    }
                                }
                            ]
                        },
                        "diagnosticsProfile": {
                            "bootDiagnostics": {
                                "enabled": true,
                                "storageUri": "[parameters('StorageAccount_BlobUri')]"
                            }
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex(), '/OMSLinux')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "OMSExtension-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "OmsAgentForLinux",
                        "typeHandlerVersion": "1.7",
                        "settings": {
                            "workspaceId": "[parameters('LogAnalytics_WorkspaceId')]"
                        },
                        "protectedSettings": {
                            "workspaceKey": "[parameters('LogAnalytics_WorkspacePrimaryKey')]"
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex(), '/LinuxDependencyAgent')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "DependencyExtensionLinux-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                        "type": "DependencyAgentLinux",
                        "typeHandlerVersion": "9.5",
                        "autoUpgradeMinorVersion": true
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex(), '/LinuxDiagnostics')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "DIAGExtensionLinux-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Diagnostics",
                        "type": "LinuxDiagnostic",
                        "typeHandlerVersion": "3.0",
                        "autoUpgradeMinorVersion": true,
                        "protectedSettings": {
                            "storageAccountName": "[parameters('StorageAccount_Name')]",
                            "storageAccountEndPoint": "https://core.windows.net",
                            "storageAccountSasToken": "[listAccountSas(parameters('StorageAccount_Id'), '2019-06-01', parameters('sasRequestBody')).accountSasToken]"
                        },
                        "settings": {
                            "StorageAccount": "[parameters('StorageAccount_Name')]",
                            "ladCfg": {
                                "diagnosticMonitorConfiguration": {
                                    "eventVolume": "Medium",
                                    "metrics": {
                                        "metricAggregation": [
                                            {
                                                "scheduledTransferPeriod": "PT1H"
                                            },
                                            {
                                                "scheduledTransferPeriod": "PT1M"
                                            }
                                        ],
                                        "resourceId": "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                                    },
                                    "performanceCounters": {
                                        "performanceCounterConfiguration": [
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Read Guest OS",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "readbytespersecond",
                                                "counterSpecifier": "/builtin/disk/readbytespersecond",
                                                "type": "builtin",
                                                "unit": "BytesPerSecond"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Writes",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "writespersecond",
                                                "counterSpecifier": "/builtin/disk/writespersecond",
                                                "type": "builtin",
                                                "unit": "CountPerSecond"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Transfer Time",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "averagetransfertime",
                                                "counterSpecifier": "/builtin/disk/averagetransfertime",
                                                "type": "builtin",
                                                "unit": "Seconds"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Transfers",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "transferspersecond",
                                                "counterSpecifier": "/builtin/disk/transferspersecond",
                                                "type": "builtin",
                                                "unit": "CountPerSecond"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Write Guest OS",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "writebytespersecond",
                                                "counterSpecifier": "/builtin/disk/writebytespersecond",
                                                "type": "builtin",
                                                "unit": "BytesPerSecond"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Read Time",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "averagereadtime",
                                                "counterSpecifier": "/builtin/disk/averagereadtime",
                                                "type": "builtin",
                                                "unit": "Seconds"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Write Time",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "averagewritetime",
                                                "counterSpecifier": "/builtin/disk/averagewritetime",
                                                "type": "builtin",
                                                "unit": "Seconds"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Total Bytes",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "bytespersecond",
                                                "counterSpecifier": "/builtin/disk/bytespersecond",
                                                "type": "builtin",
                                                "unit": "BytesPerSecond"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Reads",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "readspersecond",
                                                "counterSpecifier": "/builtin/disk/readspersecond",
                                                "type": "builtin",
                                                "unit": "CountPerSecond"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Disk Queue Length",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "disk",
                                                "condition": "IsAggregate=TRUE",
                                                "counter": "averagediskqueuelength",
                                                "counterSpecifier": "/builtin/disk/averagediskqueuelength",
                                                "type": "builtin",
                                                "unit": "Count"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Network In Guest OS",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "network",
                                                "counter": "bytesreceived",
                                                "counterSpecifier": "/builtin/network/bytesreceived",
                                                "type": "builtin",
                                                "unit": "Bytes"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Network Total Bytes",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "network",
                                                "counter": "bytestotal",
                                                "counterSpecifier": "/builtin/network/bytestotal",
                                                "type": "builtin",
                                                "unit": "Bytes"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Network Out Guest OS",
                                                        "locale": "en-us"
                                                    }
                                                ],
                                                "class": "network",
                                                "counter": "bytestransmitted",
                                                "counterSpecifier": "/builtin/network/bytestransmitted",
                                                "type": "builtin",
                                                "unit": "Bytes"
                                            },
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Network collisions", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "network", 
                                                "counter": "totalcollisions", 
                                                "counterSpecifier": "/builtin/network/totalcollisions", 
                                                "type": "builtin", 
                                                "unit": "Count"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Packets received errors", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "network", 
                                                "counter": "totalrxerrors", 
                                                "counterSpecifier": "/builtin/network/totalrxerrors", 
                                                "type": "builtin", 
                                                "unit": "Count"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Packets sent", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "network", 
                                                "counter": "packetstransmitted", 
                                                "counterSpecifier": "/builtin/network/packetstransmitted", 
                                                "type": "builtin", 
                                                "unit": "Count"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Packets received", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "network", 
                                                "counter": "packetsreceived", 
                                                "counterSpecifier": "/builtin/network/packetsreceived", 
                                                "type": "builtin", 
                                                "unit": "Count"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Packets sent errors", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "network", 
                                                "counter": "totaltxerrors", 
                                                "counterSpecifier": "/builtin/network/totaltxerrors", 
                                                "type": "builtin", 
                                                "unit": "Count"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem transfers/sec", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "transferspersecond", 
                                                "counterSpecifier": "/builtin/filesystem/transferspersecond", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem % free space", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentfreespace", 
                                                "counterSpecifier": "/builtin/filesystem/percentfreespace", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem % used space", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentusedspace", 
                                                "counterSpecifier": "/builtin/filesystem/percentusedspace", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem used space", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "usedspace", 
                                                "counterSpecifier": "/builtin/filesystem/usedspace", 
                                                "type": "builtin", 
                                                "unit": "Bytes"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem read bytes/sec", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "bytesreadpersecond", 
                                                "counterSpecifier": "/builtin/filesystem/bytesreadpersecond", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem free space", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "freespace", 
                                                "counterSpecifier": "/builtin/filesystem/freespace", 
                                                "type": "builtin", 
                                                "unit": "Bytes"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem % free inodes", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentfreeinodes", 
                                                "counterSpecifier": "/builtin/filesystem/percentfreeinodes", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem bytes/sec", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "bytespersecond", 
                                                "counterSpecifier": "/builtin/filesystem/bytespersecond", 
                                                "type": "builtin", 
                                                "unit": "BytesPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem reads/sec", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "readspersecond", 
                                                "counterSpecifier": "/builtin/filesystem/readspersecond", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem write bytes/sec", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "byteswrittenpersecond", 
                                                "counterSpecifier": "/builtin/filesystem/byteswrittenpersecond", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem writes/sec", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "writespersecond", 
                                                "counterSpecifier": "/builtin/filesystem/writespersecond", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Filesystem % used inodes", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "filesystem", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentusedinodes", 
                                                "counterSpecifier": "/builtin/filesystem/percentusedinodes", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "CPU IO wait time", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "processor", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentiowaittime", 
                                                "counterSpecifier": "/builtin/processor/percentiowaittime", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "CPU user time", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "processor", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentusertime", 
                                                "counterSpecifier": "/builtin/processor/percentusertime", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "CPU nice time", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "processor", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentnicetime", 
                                                "counterSpecifier": "/builtin/processor/percentnicetime", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "CPU percentage guest OS", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "processor", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentprocessortime", 
                                                "counterSpecifier": "/builtin/processor/percentprocessortime", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "CPU interrupt time", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "processor", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentinterrupttime", 
                                                "counterSpecifier": "/builtin/processor/percentinterrupttime", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "CPU idle time", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "processor", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentidletime", 
                                                "counterSpecifier": "/builtin/processor/percentidletime", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "CPU privileged time", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "processor", 
                                                "condition": "IsAggregate=TRUE", 
                                                "counter": "percentprivilegedtime", 
                                                "counterSpecifier": "/builtin/processor/percentprivilegedtime", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Memory available", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "availablememory", 
                                                "counterSpecifier": "/builtin/memory/availablememory", 
                                                "type": "builtin", 
                                                "unit": "Bytes"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Swap percent used", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "percentusedswap", 
                                                "counterSpecifier": "/builtin/memory/percentusedswap", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Memory used", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "usedmemory", 
                                                "counterSpecifier": "/builtin/memory/usedmemory", 
                                                "type": "builtin", 
                                                "unit": "Bytes"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Page reads", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "pagesreadpersec", 
                                                "counterSpecifier": "/builtin/memory/pagesreadpersec", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Swap available", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "availableswap", 
                                                "counterSpecifier": "/builtin/memory/availableswap", 
                                                "type": "builtin", 
                                                "unit": "Bytes"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Swap percent available", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "percentavailableswap", 
                                                "counterSpecifier": "/builtin/memory/percentavailableswap", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Mem. percent available", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "percentavailablememory", 
                                                "counterSpecifier": "/builtin/memory/percentavailablememory", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Pages", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "pagespersec", 
                                                "counterSpecifier": "/builtin/memory/pagespersec", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Swap used", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "usedswap", 
                                                "counterSpecifier": "/builtin/memory/usedswap", 
                                                "type": "builtin", 
                                                "unit": "Bytes"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Memory percentage", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "percentusedmemory", 
                                                "counterSpecifier": "/builtin/memory/percentusedmemory", 
                                                "type": "builtin", 
                                                "unit": "Percent"
                                            }, 
                                            {
                                                "annotation": [
                                                    {
                                                        "displayName": "Page writes", 
                                                        "locale": "en-us"
                                                    }
                                                ], 
                                                "class": "memory", 
                                                "counter": "pageswrittenpersec", 
                                                "counterSpecifier": "/builtin/memory/pageswrittenpersec", 
                                                "type": "builtin", 
                                                "unit": "CountPerSecond"
                                            }                                        
                                        ]
                                    },
                                    "sysLogEvents": {
                                        "syslogEventConfiguration": {
                                            "LOG_AUTH": "LOG_DEBUG",
                                            "LOG_AUTHPRIV": "LOG_DEBUG",
                                            "LOG_CRON": "LOG_DEBUG",
                                            "LOG_DAEMON": "LOG_DEBUG",
                                            "LOG_FTP": "LOG_DEBUG",
                                            "LOG_KERN": "LOG_DEBUG",
                                            "LOG_LOCAL0": "LOG_DEBUG",
                                            "LOG_LOCAL1": "LOG_DEBUG",
                                            "LOG_LOCAL2": "LOG_DEBUG",
                                            "LOG_LOCAL3": "LOG_DEBUG",
                                            "LOG_LOCAL4": "LOG_DEBUG",
                                            "LOG_LOCAL5": "LOG_DEBUG",
                                            "LOG_LOCAL6": "LOG_DEBUG",
                                            "LOG_LOCAL7": "LOG_DEBUG",
                                            "LOG_LPR": "LOG_DEBUG",
                                            "LOG_MAIL": "LOG_DEBUG",
                                            "LOG_NEWS": "LOG_DEBUG",
                                            "LOG_SYSLOG": "LOG_DEBUG",
                                            "LOG_USER": "LOG_DEBUG",
                                            "LOG_UUCP": "LOG_DEBUG"
                                        }
                                    }
                                },
                                "sampleRateInSeconds": 15
                            }
                        }
                    }
                },
                {
                    "condition": "[and(equals(parameters('Operating_System'), 'Linux'), not(empty(parameters('QualysAgentLinux_LicenseCode'))))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex(), '/QualysAgentLinux')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "QualysAgentLinux-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Qualys",
                        "type": "QualysAgentLinux",
                        "typeHandlerVersion": "1.6",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "LicenseCode": "[parameters('QualysAgent_LicenseCode')]",
                            "ResourceID": "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]",
                            "VmRegion": "[parameters('Location')]",
                            "Logging": "Enabled"
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex())]",
                    "location": "[parameters('Location')]",
                    "copy": {
                        "name": "VM-Copy_Windows",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "hardwareProfile": {
                            "vmSize": "Standard_F2s_v2"
                        },
                        "storageProfile": {
                            "imageReference": {
                                "publisher": "[variables('vmImage')[parameters('Operating_System')].publisher]",
                                "offer": "[variables('vmImage')[parameters('Operating_System')].offer]",
                                "sku": "[variables('vmImage')[parameters('Operating_System')].sku]",
                                "version": "[variables('vmImage')[parameters('Operating_System')].version]"
                            },
                            "osDisk": {
                                "createOption": "FromImage",
                                "name": "[concat(variables('vmName'), 'OSDisk-', copyIndex())]",
                                "caching": "ReadWrite",
                                "diskSizeGB": 128
                            },
                            "dataDisks": []
                        },
                        "osProfile": {
                            "computerName": "[concat('My', parameters('Operating_System'), 'Agent', copyIndex())]",
                            "adminUserName": "[parameters('adminUserName')]",
                            "adminPassword": "[parameters('KeyVault_AdminPassword')]",
                            "windowsConfiguration": {
                                "provisionVMAgent": true,
                                "enableAutomaticUpdates": true
                            }
                        },
                        "networkProfile": {
                            "networkInterfaces": [
                                {
                                    "id": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups/', parameters('Prefix'), '-Network-RG/providers/Microsoft.Network/networkInterfaces/', parameters('Prefix'), '-NIC-', copyIndex())]",
                                    "properties": {
                                        "primary": true
                                    }
                                }
                            ]
                        },
                        "diagnosticsProfile": {
                            "bootDiagnostics": {
                                "enabled": true,
                                "storageUri": "[parameters('StorageAccount_BlobUri')]"
                            }
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex(), '/OMSWindows')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "MMAExtension-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "MicrosoftMonitoringAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "workspaceId": "[parameters('LogAnalytics_WorkspaceId')]"
                        },
                        "protectedSettings": {
                            "workspaceKey": "[parameters('LogAnalytics_WorkspacePrimaryKey')]"
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex(), '/WindowsDependencyAgent')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "DependencyExtensionWindows-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                        "type": "DependencyAgentWindows",
                        "typeHandlerVersion": "9.5",
                        "autoUpgradeMinorVersion": true
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex(), '/WindowsDiagnostics')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "DIAGExtensionWindows-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Diagnostics",
                        "type": "IaaSDiagnostics",
                        "typeHandlerVersion": "1.5",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "xmlCfg": "[base64(concat(variables('wadcfgxstart'), variables('wadmetricsresourceid'), concat(variables('vmName'), 'Windows', copyIndex(), variables('wadcfgxend'))))]",
                            "storageAccount": "[parameters('StorageAccount_Name')]"
                        },
                        "protectedSettings": {
                            "storageAccountName": "[parameters('StorageAccount_Name')]",
                            "storageAccountKey": "[listKeys(parameters('StorageAccount_Id'), '2019-06-01').keys[0].value]",
                            "storageAccountEndPoint": "https://core.windows.net"
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex(), '/QualysAgentWindows')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "QualysAgentWindows-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Qualys",
                        "type": "QualysAgent",
                        "typeHandlerVersion": "1.6",
                        "autoUpgradeMinorVersion": false,
                        "settings": {
                            "LicenseCode": "[parameters('QualysAgent_LicenseCode')]",
                            "ResourceID": "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]",
                            "VmRegion": "[parameters('Location')]",
                            "Logging": "Enabled"
                        }
                    }
                }
            ],
            "outputs": {
                "generatedSasToken": {
                    "type": "string",
                    "value": "[listAccountSas(parameters('StorageAccount_Id'), '2019-06-01', parameters('sasRequestBody')).accountSasToken]"
                }
            }
        },
        "resourceGroup": "Compute-RG",
        "parameters": {
            "Prefix": {
                "value": "[parameters('Prefix')]"
            },
            "Location": {
                "value": "[parameters('Azure_Region')]"
            },
            "Cluster_Size": {
                "value": "[parameters('Cluster_Size')]"
            },
            "Operating_System": {
                "value": "[parameters('Agent_OperatingSystem')]"
            },
            "KeyVault_Reference": {
                "value": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
            },
            "KeyVault_AdminPassword": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "adminPwd"
                }
            },
            "KeyVault_AdminSsh": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "adminSsh"
                }
            },
            "StorageAccount_BlobUri": {
                "value": "[artifacts('artifact-template-storage-account--deploy').outputs.storageAccountPrimaryEndpointsBlobUri]"
            },
            "LogAnalytics_WorkspaceId": {
                "value": "[artifacts('artifact-template-loganalytics--deploy').outputs.logAnalyticsCustomerId]"
            },
            "LogAnalytics_WorkspacePrimaryKey": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "LogAnalyticsPrimaryKey"
                }
            },
            "StorageAccount_Name": {
                "value": "[artifacts('artifact-template-storage-account--deploy').outputs.storageAccountName]"
            },
            "StorageAccount_Id": {
                "value": "[artifacts('artifact-template-storage-account--deploy').outputs.storageAccountId]"
            },
            "QualysAgent_LicenseCode": {
                "value": "sdfkhjsajhdflkjsaghdlfks.ldkfhslhdf;lsahkjdlkjfhsadkjhfkjhfkjsdhfkjdshfhidhsfkj"
            },
            "QualysAgentLinux_LicenseCode": {
                "value": ""
            }
        }
    }
}