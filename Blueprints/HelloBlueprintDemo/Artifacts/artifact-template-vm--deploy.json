{
    "kind": "template",
    "name": "VirtualMachine",
    "properties": {
        "displayName": "Virtual Machines",
        "description": "Virtual Machines that will host our DevOps agents.",
        "dependsOn": [
            "artifact-template-keyvault--deploy",
            "artifact-template-network-interface--deploy",
            "artifact-template-storage-account--deploy",
            "artifact-template-loganalytics--deploy"
        ],
        "template": {
            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
            "contentVersion": "1.0.0.0",
            "parameters": {
                "Prefix": {
                    "type": "string"
                },
                "Location": {
                    "type": "string"
                },
                "Cluster_Size": {
                    "type": "int"
                },
                "Operating_System": {
                    "type": "string",
                    "allowedValues": [
                        "Windows",
                        "Linux"
                    ]
                },
                "adminUserName": {
                    "type": "string",
                    "defaultValue": "ansible"
                },
                "KeyVault_Reference": {
                    "type": "string"
                },
                "KeyVault_AdminPassword": {
                    "type": "securestring"
                },
                "KeyVault_AdminSsh": {
                    "type": "securestring"
                },
                "StorageAccount_BlobUri": {
                    "type": "string"
                },
                "LogAnalytics_WorkspaceId": {
                    "type": "string"
                },
                "LogAnalytics_WorkspacePrimaryKey": {
                    "type": "securestring"
                },
                "StorageAccount_Name": {
                    "type": "string"
                },
                "StorageAccount_Id": {
                    "type": "string"
                },
                "StorageAccount_RG": {
                    "type": "string"
                }
            },
            "variables": {
                "vmName": "[concat(parameters('Prefix'), '-VM-')]",
                "vmImage": {
                    "Linux": {
                        "publisher": "Canonical",
                        "offer": "UbuntuServer",
                        "sku": "18.04-LTS",
                        "version": "latest"
                    },
                    "Windows": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    }
                },
                "wadlogs": "<WadCfg> <DiagnosticMonitorConfiguration overallQuotaInMB=\"4096\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"> <DiagnosticInfrastructureLogs scheduledTransferLogLevelFilter=\"Error\"/> <WindowsEventLog scheduledTransferPeriod=\"PT1M\" > <DataSource name=\"Application!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"Security!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"System!*[System[(Level = 1 or Level = 2)]]\" /></WindowsEventLog>",
                "wadperfcounters1": "<PerformanceCounters scheduledTransferPeriod=\"PT1M\"><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU utilization\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Privileged Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU privileged time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% User Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU user time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor Information(_Total)\\Processor Frequency\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"CPU frequency\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\System\\Processes\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Processes\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Thread Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Threads\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Handle Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Handles\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\% Committed Bytes In Use\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Memory usage\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Available Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory available\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory committed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Commit Limit\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory commit limit\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active time\" locale=\"en-us\"/></PerformanceCounterConfiguration>",
                "wadperfcounters2": "<PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Read Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active read time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Write Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active write time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Transfers/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Reads/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk read operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Writes/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk write operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Read Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk read speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Write Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk write speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\LogicalDisk(_Total)\\% Free Space\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk free space (percentage)\" locale=\"en-us\"/></PerformanceCounterConfiguration></PerformanceCounters>",
                "wadcfgxstart": "[concat(variables('wadlogs'), variables('wadperfcounters1'), variables('wadperfcounters2'), '<Metrics resourceId=\"')]",
                "wadmetricsresourceid": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups', parameters('Prefix'), '-Compute-RG/providers/Microsoft.Compute/virtualMachines/')]",
                "wadcfgxend": "\"><MetricAggregation scheduledTransferPeriod=\"PT1H\"/><MetricAggregation scheduledTransferPeriod=\"PT1M\"/></Metrics></DiagnosticMonitorConfiguration></WadCfg>"
            },
            "resources": [
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex())]",
                    "location": "[parameters('Location')]",
                    "copy": {
                        "name": "VM-Copy_Linux",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "hardwareProfile": {
                            "vmSize": "Standard_F2s_v2"
                        },
                        "storageProfile": {
                            "imageReference": {
                                "publisher": "[variables('vmImage')[parameters('Operating_System')].publisher]",
                                "offer": "[variables('vmImage')[parameters('Operating_System')].offer]",
                                "sku": "[variables('vmImage')[parameters('Operating_System')].sku]",
                                "version": "[variables('vmImage')[parameters('Operating_System')].version]"
                            },
                            "dataDisks": [],
                            "osDisk": {
                                "name": "[concat(variables('vmName'), 'OSDisk-', copyIndex())]",
                                "createOption": "FromImage",
                                "caching": "ReadWrite",
                                "diskSizeGB": 30
                            }
                        },
                        "osProfile": {
                            "computerName": "[concat('My', parameters('Operating_System'), 'Agent-', copyIndex())]",
                            "adminUserName": "[parameters('adminUserName')]",
                            "linuxConfiguration": {
                                "disablePasswordAuthentication": true,
                                "provisionVMAgent": true,
                                "ssh": {
                                    "publicKeys": [
                                        {
                                            "path": "[concat('/home/', parameters('adminUserName'), '/.ssh/authorized_keys')]",
                                            "keyData": "[parameters('KeyVault_AdminSsh')]"
                                        }
                                    ]
                                }
                            }
                        },
                        "networkProfile": {
                            "networkInterfaces": [
                                {
                                    "id": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups/', parameters('Prefix'), '-Network-RG/providers/Microsoft.Network/networkInterfaces/', parameters('Prefix'), '-NIC-', copyIndex())]",
                                    "properties": {
                                        "primary": true
                                    }
                                }
                            ]
                        },
                        "diagnosticsProfile": {
                            "bootDiagnostics": {
                                "enabled": true,
                                "storageUri": "[parameters('StorageAccount_BlobUri')]"
                            }
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex(), '/OMSLinux')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "OMSExtension-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "OmsAgentForLinux",
                        "typeHandlerVersion": "1.7",
                        "settings": {
                            "workspaceId": "[parameters('LogAnalytics_WorkspaceId')]"
                        },
                        "protectedSettings": {
                            "workspaceKey": "[parameters('LogAnalytics_WorkspacePrimaryKey')]"
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex(), '/LinuxDependencyAgent')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "DependencyExtensionLinux-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                        "type": "DependencyAgentLinux",
                        "typeHandlerVersion": "9.5",
                        "autoUpgradeMinorVersion": true
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex())]",
                    "location": "[parameters('Location')]",
                    "copy": {
                        "name": "VM-Copy_Windows",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "hardwareProfile": {
                            "vmSize": "Standard_F2s_v2"
                        },
                        "storageProfile": {
                            "imageReference": {
                                "publisher": "[variables('vmImage')[parameters('Operating_System')].publisher]",
                                "offer": "[variables('vmImage')[parameters('Operating_System')].offer]",
                                "sku": "[variables('vmImage')[parameters('Operating_System')].sku]",
                                "version": "[variables('vmImage')[parameters('Operating_System')].version]"
                            },
                            "osDisk": {
                                "createOption": "FromImage",
                                "name": "[concat(variables('vmName'), 'OSDisk-', copyIndex())]",
                                "caching": "ReadWrite",
                                "diskSizeGB": 128
                            },
                            "dataDisks": []
                        },
                        "osProfile": {
                            "computerName": "[concat('My', parameters('Operating_System'), 'Agent', copyIndex())]",
                            "adminUserName": "[parameters('adminUserName')]",
                            "adminPassword": "[parameters('KeyVault_AdminPassword')]",
                            "windowsConfiguration": {
                                "provisionVMAgent": true,
                                "enableAutomaticUpdates": true
                            }
                        },
                        "networkProfile": {
                            "networkInterfaces": [
                                {
                                    "id": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups/', parameters('Prefix'), '-Network-RG/providers/Microsoft.Network/networkInterfaces/', parameters('Prefix'), '-NIC-', copyIndex())]",
                                    "properties": {
                                        "primary": true
                                    }
                                }
                            ]
                        },
                        "diagnosticsProfile": {
                            "bootDiagnostics": {
                                "enabled": true,
                                "storageUri": "[parameters('StorageAccount_BlobUri')]"
                            }
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex(), '/OMSWindows')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "MMAExtension-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "MicrosoftMonitoringAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "workspaceId": "[parameters('LogAnalytics_WorkspaceId')]"
                        },
                        "protectedSettings": {
                            "workspaceKey": "[parameters('LogAnalytics_WorkspacePrimaryKey')]"
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex(), '/WindowsDependencyAgent')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "DependencyExtensionWindows-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                        "type": "DependencyAgentWindows",
                        "typeHandlerVersion": "9.5",
                        "autoUpgradeMinorVersion": true
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex(), '/WindowsDiagnostics')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "DIAGExtensionWindows-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Diagnostics",
                        "type": "IaaSDiagnostics",
                        "typeHandlerVersion": "1.5",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "xmlCfg": "[base64(concat(variables('wadcfgxstart'), variables('wadmetricsresourceid'), concat(variables('vmName'), 'Windows', copyIndex(), variables('wadcfgxend'))))]",
                            "storageAccount": "[parameters('StorageAccount_Name')]"
                        },
                        "protectedSettings": {
                            "storageAccountName": "[parameters('StorageAccount_Name')]",
                            "storageAccountKey": "[listKeys(parameters('StorageAccount_Id'), '2019-06-01').key1]",
                            "storageAccountEndPoint": "https://core.windows.net"
                        }
                    }
                }
            ],
            "outputs": {}
        },
        "resourceGroup": "Compute-RG",
        "parameters": {
            "Prefix": {
                "value": "[parameters('Prefix')]"
            },
            "Location": {
                "value": "[parameters('Azure_Region')]"
            },
            "Cluster_Size": {
                "value": "[parameters('Cluster_Size')]"
            },
            "Operating_System": {
                "value": "[parameters('Agent_OperatingSystem')]"
            },
            "KeyVault_Reference": {
                "value": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
            },
            "KeyVault_AdminPassword": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "adminPwd"
                }
            },
            "KeyVault_AdminSsh": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "adminSsh"
                }
            },
            "StorageAccount_BlobUri": {
                "value": "[artifacts('artifact-template-storage-account--deploy').outputs.storageAccountPrimaryEndpointsBlobUri]"
            },
            "LogAnalytics_WorkspaceId": {
                "value": "[artifacts('artifact-template-loganalytics--deploy').outputs.logAnalyticsCustomerId]"
            },
            "LogAnalytics_WorkspacePrimaryKey": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "LogAnalyticsPrimaryKey"
                }
            },
            "StorageAccount_Name": {
                "value": "[artifacts('artifact-template-storage-account--deploy').outputs.storageAccountName]"
            },
            "StorageAccount_Id": {
                "value": "[artifacts('artifact-template-storage-account--deploy').outputs.storageAccountId]"
            },
            "StorageAccount_RG": {
                "value": "[resourceGroups('Storage-RG').name]"
            }
        }
    }
}