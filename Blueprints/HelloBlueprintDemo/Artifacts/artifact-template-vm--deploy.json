{
    "kind": "template",
    "name": "VirtualMachine",
    "properties": {
        "displayName": "Virtual Machines",
        "description": "Virtual Machines that will host our DevOps agents.",
        "dependsOn": [
            "artifact-template-keyvault--deploy",
            "artifact-template-network-interface--deploy",
            "artifact-template-storage-account--deploy",
            "artifact-template-loganalytics--deploy"
        ],
        "template": {
            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
            "contentVersion": "1.0.0.0",
            "parameters": {
                "Prefix": {
                    "type": "string"
                },
                "Location": {
                    "type": "string"
                },
                "Cluster_Size": {
                    "type": "int"
                },
                "Operating_System": {
                    "type": "string",
                    "allowedValues": [
                        "Windows",
                        "Linux"
                    ]
                },
                "adminUserName": {
                    "type": "string",
                    "defaultValue": "ansible"
                },
                "KeyVault_Reference": {
                    "type": "string"
                },
                "KeyVault_AdminPassword": {
                    "type": "securestring"
                },
                "KeyVault_AdminSsh": {
                    "type": "securestring"
                },
                "StorageAccount_BlobUri": {
                    "type": "string"
                },
                "LogAnalytics_WorkspaceId": {
                    "type": "string"
                },
                "LogAnalytics_WorkspacePrimaryKey": {
                    "type": "securestring"
                }
            },
            "variables": {
                "vmName": "[concat(parameters('Prefix'), '-VM-')]",
                "vmImage": {
                    "Linux": {
                        "publisher": "Canonical",
                        "offer": "UbuntuServer",
                        "sku": "18.04-LTS",
                        "version": "latest"
                    },
                    "Windows": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    }
                }
            },
            "resources": [
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex())]",
                    "location": "[parameters('Location')]",
                    "copy": {
                        "name": "VM-Copy_Linux",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "hardwareProfile": {
                            "vmSize": "Standard_F2s_v2"
                        },
                        "storageProfile": {
                            "imageReference": {
                                "publisher": "[variables('vmImage')[parameters('Operating_System')].publisher]",
                                "offer": "[variables('vmImage')[parameters('Operating_System')].offer]",
                                "sku": "[variables('vmImage')[parameters('Operating_System')].sku]",
                                "version": "[variables('vmImage')[parameters('Operating_System')].version]"
                            },
                            "dataDisks": [],
                            "osDisk": {
                                "name": "[concat(variables('vmName'), 'OSDisk-', copyIndex())]",
                                "createOption": "FromImage",
                                "caching": "ReadWrite",
                                "diskSizeGB": 30
                            }
                        },
                        "osProfile": {
                            "computerName": "[concat('My', parameters('Operating_System'), 'Agent-', copyIndex())]",
                            "adminUserName": "[parameters('adminUserName')]",
                            "linuxConfiguration": {
                                "disablePasswordAuthentication": true,
                                "provisionVMAgent": true,
                                "ssh": {
                                    "publicKeys": [
                                        {
                                            "path": "[concat('/home/', parameters('adminUserName'), '/.ssh/authorized_keys')]",
                                            "keyData": "[parameters('KeyVault_AdminSsh')]"
                                        }
                                    ]
                                }
                            }
                        },
                        "networkProfile": {
                            "networkInterfaces": [
                                {
                                    "id": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups/', parameters('Prefix'), '-Network-RG/providers/Microsoft.Network/networkInterfaces/', parameters('Prefix'), '-NIC-', copyIndex())]",
                                    "properties": {
                                        "primary": true
                                    }
                                }
                            ]
                        },
                        "diagnosticsProfile": {
                            "bootDiagnostics": {
                                "enabled": true,
                                "storageUri": "[parameters('StorageAccount_BlobUri')]"
                            }
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Linux')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Linux', copyIndex(), '/OMSLinux')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Linux', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "OMSExtension-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "OmsAgentForLinux",
                        "typeHandlerVersion": "1.7",
                        "settings": {
                            "workspaceId": "[parameters('LogAnalytics_WorkspaceId')]"
                        },
                        "protectedSettings": {
                            "workspaceKey": "[parameters('LogAnalytics_WorkspacePrimaryKey')]"
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex())]",
                    "location": "[parameters('Location')]",
                    "copy": {
                        "name": "VM-Copy_Windows",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "hardwareProfile": {
                            "vmSize": "Standard_F2s_v2"
                        },
                        "storageProfile": {
                            "imageReference": {
                                "publisher": "[variables('vmImage')[parameters('Operating_System')].publisher]",
                                "offer": "[variables('vmImage')[parameters('Operating_System')].offer]",
                                "sku": "[variables('vmImage')[parameters('Operating_System')].sku]",
                                "version": "[variables('vmImage')[parameters('Operating_System')].version]"
                            },
                            "osDisk": {
                                "createOption": "FromImage",
                                "name": "[concat(variables('vmName'), 'OSDisk-', copyIndex())]",
                                "caching": "ReadWrite",
                                "diskSizeGB": 128
                            },
                            "dataDisks": []
                        },
                        "osProfile": {
                            "computerName": "[concat('My', parameters('Operating_System'), 'Agent', copyIndex())]",
                            "adminUserName": "[parameters('adminUserName')]",
                            "adminPassword": "[parameters('KeyVault_AdminPassword')]",
                            "windowsConfiguration": {
                                "provisionVMAgent": true,
                                "enableAutomaticUpdates": true
                            }
                        },
                        "networkProfile": {
                            "networkInterfaces": [
                                {
                                    "id": "[concat('/subscriptions/ac658ff9-95d0-4719-9f1f-58c5554960c9/resourceGroups/', parameters('Prefix'), '-Network-RG/providers/Microsoft.Network/networkInterfaces/', parameters('Prefix'), '-NIC-', copyIndex())]",
                                    "properties": {
                                        "primary": true
                                    }
                                }
                            ]
                        },
                        "diagnosticsProfile": {
                            "bootDiagnostics": {
                                "enabled": true,
                                "storageUri": "[parameters('StorageAccount_BlobUri')]"
                            }
                        }
                    }
                },
                {
                    "condition": "[equals(parameters('Operating_System'), 'Windows')]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "apiVersion": "2019-12-01",
                    "name": "[concat(variables('vmName'), 'Windows', copyIndex, '/OMSWindows')]",
                    "location": "[parameters('Location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('vmName'), 'Windows', copyIndex()))]"
                    ],
                    "copy": {
                        "name": "MMAExtension-Copy",
                        "count": "[parameters('Cluster_Size')]"
                    },
                    "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "MicrosoftMonitoringAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "workspaceId": "[parameters('LogAnalytics_WorkspaceId')]"
                        },
                        "protectedSettings": {
                            "workspaceKey": "[parameters('LogAnalytics_WorkspacePrimaryKey')]"
                        }
                    }
                }
            ],
            "outputs": {}
        },
        "resourceGroup": "Compute-RG",
        "parameters": {
            "Prefix": {
                "value": "[parameters('Prefix')]"
            },
            "Location": {
                "value": "[parameters('Azure_Region')]"
            },
            "Cluster_Size": {
                "value": "[parameters('Cluster_Size')]"
            },
            "Operating_System": {
                "value": "[parameters('Agent_OperatingSystem')]"
            },
            "KeyVault_Reference": {
                "value": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
            },
            "KeyVault_AdminPassword": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "adminPwd"
                }
            },
            "KeyVault_AdminSsh": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "adminSsh"
                }
            },
            "StorageAccount_BlobUri": {
                "value": "[artifacts('artifact-template-storage-account--deploy').outputs.storageAccountPrimaryEndpointsBlobUri]"
            },
            "LogAnalytics_WorkspaceId": {
                "value": "[artifacts('artifact-template-loganalytics--deploy').outputs.logAnalyticsCustomerId]"
            },
            "LogAnalytics_WorkspacePrimaryKey": {
                "reference": {
                    "keyvault": {
                        "id": "[artifacts('artifact-template-keyvault--deploy').outputs.myKeyVaultId]"
                    },
                    "secretName": "LogAnalyticsPrimaryKey"
                }
            }
        }
    }
}